<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>L·∫•y M√£ 2FA</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="container">
    <div class="card main-card">
      <div class="logo">
        <div class="logo-icon">üîê</div>
        <h1>L·∫•y M√£ 2FA</h1>
      </div>

      <div class="input-group">
        <label for="email">Nh·∫≠p Email Gmail</label>
        <input type="email" id="email" placeholder="example@gmail.com" autocomplete="off">
      </div>

      <button id="getCodeBtn" class="btn-primary">
        <span class="btn-text">L·∫•y M√£ 2FA</span>
        <span class="btn-loader" style="display: none;"></span>
      </button>

      <div id="result" class="result-container" style="display: none;">
        <div class="code-display">
          <span id="code1" class="code-digit">-</span>
          <span id="code2" class="code-digit">-</span>
          <span id="code3" class="code-digit">-</span>
          <span class="code-separator"></span>
          <span id="code4" class="code-digit">-</span>
          <span id="code5" class="code-digit">-</span>
          <span id="code6" class="code-digit">-</span>
        </div>
        <div class="timer-container">
          <div class="timer-bar">
            <div id="timerProgress" class="timer-progress"></div>
          </div>
          <span id="timerText">30s</span>
        </div>
        <button id="copyBtn" class="btn-secondary">
          üìã Copy M√£
        </button>
      </div>

      <div id="error" class="error-message" style="display: none;"></div>
    </div>

    <!-- Seller Info Card -->
    <div class="card seller-card">
      <div class="seller-header">
        <span class="seller-icon">üë§</span>
        <div class="seller-info">
          <h3>B√πi Anh</h3>
          <a href="https://zalo.me/0943107897" class="zalo-link">üì± Zalo: 0943107897</a>
        </div>
      </div>
      <div class="products-list">
        <h4>üõí C√°c M·∫∑t H√†ng ƒêang B√°n:</h4>
        <ul id="productsList">
          <li><span class="product-name">ƒêang t·∫£i...</span></li>
        </ul>
      </div>
    </div>

    <footer>
      <a href="admin.html" class="admin-link">‚öôÔ∏è Admin</a>
    </footer>
  </div>

  <script>
    const emailInput = document.getElementById('email');
    const getCodeBtn = document.getElementById('getCodeBtn');
    const resultContainer = document.getElementById('result');
    const errorDiv = document.getElementById('error');
    const copyBtn = document.getElementById('copyBtn');
    const timerProgress = document.getElementById('timerProgress');
    const timerText = document.getElementById('timerText');

    let currentCode = '';
    let currentEmail = '';
    let timerInterval = null;
    let refreshInterval = null;

    // Enter key to submit
    emailInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') getCodeBtn.click();
    });

    getCodeBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      if (!email) {
        showError('Vui l√≤ng nh·∫≠p email');
        return;
      }

      currentEmail = email;
      await fetchCode();
    });

    async function fetchCode() {
      // Show loading
      getCodeBtn.querySelector('.btn-text').style.display = 'none';
      getCodeBtn.querySelector('.btn-loader').style.display = 'inline-block';
      getCodeBtn.disabled = true;
      errorDiv.style.display = 'none';

      try {
        const res = await fetch('/api/get-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: currentEmail })
        });

        const data = await res.json();

        if (!res.ok) {
          showError(data.error || 'C√≥ l·ªói x·∫£y ra');
          resultContainer.style.display = 'none';
          stopAutoRefresh();
          return;
        }

        currentCode = data.code;
        displayCode(data.code);
        startTimer(data.timeRemaining);
        resultContainer.style.display = 'block';

        // Setup auto refresh
        startAutoRefresh();

      } catch (err) {
        showError('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server');
        resultContainer.style.display = 'none';
      } finally {
        getCodeBtn.querySelector('.btn-text').style.display = 'inline';
        getCodeBtn.querySelector('.btn-loader').style.display = 'none';
        getCodeBtn.disabled = false;
      }
    }

    function displayCode(code) {
      const digits = code.split('');
      for (let i = 0; i < 6; i++) {
        const el = document.getElementById(`code${i + 1}`);
        el.textContent = digits[i] || '-';
        el.classList.add('pop');
        setTimeout(() => el.classList.remove('pop'), 200);
      }
    }

    function startTimer(seconds) {
      if (timerInterval) clearInterval(timerInterval);

      let remaining = seconds;
      updateTimerUI(remaining);

      timerInterval = setInterval(() => {
        remaining--;
        updateTimerUI(remaining);

        if (remaining <= 0) {
          clearInterval(timerInterval);
        }
      }, 1000);
    }

    function updateTimerUI(seconds) {
      timerText.textContent = `${seconds}s`;
      const percent = (seconds / 30) * 100;
      timerProgress.style.width = `${percent}%`;

      // Change color based on time
      if (seconds <= 5) {
        timerProgress.style.background = 'linear-gradient(90deg, #ef4444, #f87171)';
      } else if (seconds <= 10) {
        timerProgress.style.background = 'linear-gradient(90deg, #f59e0b, #fbbf24)';
      } else {
        timerProgress.style.background = 'linear-gradient(90deg, #10b981, #34d399)';
      }
    }

    function startAutoRefresh() {
      stopAutoRefresh();

      // Refresh every 30 seconds
      refreshInterval = setInterval(async () => {
        if (currentEmail) {
          await fetchCode();
        }
      }, 30000);
    }

    function stopAutoRefresh() {
      if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
      }
    }

    function showError(message) {
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    copyBtn.addEventListener('click', async () => {
      if (!currentCode) return;

      try {
        await navigator.clipboard.writeText(currentCode);
        copyBtn.textContent = '‚úÖ ƒê√£ Copy!';
        setTimeout(() => {
          copyBtn.textContent = 'üìã Copy M√£';
        }, 2000);
      } catch (err) {
        // Fallback
        const textarea = document.createElement('textarea');
        textarea.value = currentCode;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        copyBtn.textContent = '‚úÖ ƒê√£ Copy!';
        setTimeout(() => {
          copyBtn.textContent = 'üìã Copy M√£';
        }, 2000);
      }
    });

    // Load products from API
    async function loadProducts() {
      try {
        const res = await fetch('/api/products');
        const products = await res.json();
        const ul = document.getElementById('productsList');

        if (products.length === 0) {
          ul.innerHTML = '<li><span class="product-name">Ch∆∞a c√≥ s·∫£n ph·∫©m</span></li>';
          return;
        }

        ul.innerHTML = products.map(p => `
          <li>
            <span class="product-name">${escapeHtml(p.name)}</span>
            <span class="product-price">${escapeHtml(p.price)}</span>
          </li>
        `).join('');
      } catch (err) {
        console.error('Failed to load products:', err);
      }
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    // Load products on page load
    loadProducts();
  </script>
</body>

</html>